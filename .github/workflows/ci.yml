name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      non_markdown_changed: ${{ steps.changed-files.outputs.non_markdown_any_changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            markdown:
              - '**/*.md'
            non_markdown:
              - '**'
              - '!**/*.md'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache NX
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-

      - name: Install clipboard binaries (xsel/xclip)
        run: |
          sudo apt-get update
          sudo apt-get install -y xsel xclip

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Lint
        run: pnpm check

      - name: Test
        if: steps.changed-files.outputs.non_markdown_any_changed == 'true'
        run: pnpm test

  test-graceful-degradation:
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only run if build-and-test passed and there are non-markdown changes
    if: success() && needs.build-and-test.outputs.non_markdown_changed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            markdown:
              - '**/*.md'
            non_markdown:
              - '**'
              - '!**/*.md'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache NX
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-

      - name: Verify clipboard binaries are NOT installed
        run: |
          if command -v xsel &> /dev/null || command -v xclip &> /dev/null; then
            echo "ERROR: Clipboard binaries found! They should not be installed for graceful degradation testing."
            exit 1
          fi
          echo "✓ Clipboard binaries not found (as expected)"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Test graceful degradation
        if: steps.changed-files.outputs.non_markdown_any_changed == 'true'
        run: |
          # Run graceful degradation tests for machine package
          cd packages/machine && pnpm test:graceful-degradation

  test-browser:
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only run if build-and-test passed and there are non-markdown changes
    if: success() && needs.build-and-test.outputs.non_markdown_changed == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            markdown:
              - '**/*.md'
            non_markdown:
              - '**'
              - '!**/*.md'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache NX
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml', 'nx.json') }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Test browser environment
        if: steps.changed-files.outputs.non_markdown_any_changed == 'true'
        run: |
          # Run browser tests for machine package
          # These tests use happy-dom to simulate browser environment
          cd packages/machine && pnpm test:browser

  all-tests-passed:
    runs-on: ubuntu-latest
    needs: [build-and-test, test-graceful-degradation, test-browser]
    if: always()
    steps:
      - name: Check all test jobs succeeded
        run: |
          if [ "${{ needs.build-and-test.result }}" != "success" ]; then
            echo "❌ build-and-test job failed"
            exit 1
          fi
          if [ "${{ needs.test-graceful-degradation.result }}" != "success" ] && [ "${{ needs.test-graceful-degradation.result }}" != "skipped" ]; then
            echo "❌ test-graceful-degradation job failed"
            exit 1
          fi
          if [ "${{ needs.test-browser.result }}" != "success" ] && [ "${{ needs.test-browser.result }}" != "skipped" ]; then
            echo "❌ test-browser job failed"
            exit 1
          fi
          echo "✅ All test jobs passed or were appropriately skipped"

